function show_toplimit_win(type, name, cb){
  var type_content = kPageMessages['service_type_' + type],
      name_content = kPageMessages['service_competence_' + name];

  if (name === 'export') {
      $.getJSON('/json.php', {action:'get_permission'}, function (response){
          if (0 === response.status) {
              name_content = name_content.replace('#', response.permission.export_per_month);   
          }
          show_toplimit_content(type_content, name_content, cb);
      });
  } else {
      show_toplimit_content(type_content, name_content, cb);
  }
}

function close_toplimit_win(){
  $('#toplimit_win').hide();
}

function show_toplimit_content(type_content, name_content, cb) {
  if(name_content == "免费"){
    var users_type = "为标准会员";
  }else if(name_content == "标准会员"){
      var users_type = "为团队会员";
  }else if(name_content == "团队会员"){
      var users_type = "您的子账号数量";
  }else{
      var users_type = "付费会员";
  }

  if(cb) return cb($('<div>').append($('#limit_dialog_content').tmpl({
    type: type_content,
    name: name_content,
    users_type: users_type
  })).html());

  $('#limit_dialog').dialog({
    width: 450,
    title: kPageMessages.toplimit_title
  }).html($('#limit_dialog_content').tmpl({
    type: type_content,
    name: name_content,
    users_type: users_type
  }))
}

function show_storagetip_content(storage, content) {
  var win = $('#js-storagetip_win');
  $('#js-storage-content-tip').text(kPageMessages['storage_tip'].replace('{{STORAGE}}', storage).replace('{{CONTENT}}', content));
  win.show();
}

function close_storagetip_content() {
  $('#js-storagetip_win').hide();
}

function userLogout() {
  console.log($('#logout').submit());
  return false;
}

function driveMessage() {
  var $notiBadge = $('#js-noti-badge');
  if (!$notiBadge.length) return;
  var _checkInterval = 60000;
  var _isInNotificationsPage = location.href.indexOf('/notifications.php') > -1;
  var _messages = [];
  var _messageUrl = location.protocol + '//' +  location.hostname + '/message.php';

  var getUnReadMessage = function () {
    return $.get(_messageUrl, {action: 'myself', type: 'unread', page: 1, cpp: 5});
  }

  var checkServerMessage = function () {
    return $.get(_messageUrl, {action: 'check'});
  }

  var $unread = $notiBadge.find('.unread');
  var updateBadgeCount = function (count) {
    if (count === 0) {
      $unread.hide()
    } else {
      //去掉数量的显示
      $unread
        .show()
      //   .toggleClass('double', count > 99)
      //   .text(count);
    }
  }

  var refreshMessageCount = function (delta) {
    var count = +$unread.text();
    count += delta;
    updateBadgeCount(count);
  }
  window.refreshMessageCount = refreshMessageCount;

  var refreshMessageStatus = function () {
    getUnReadMessage().success(function (response){
      if (response.status === 0) {
        updateBadgeCount(response.total);
        _messages = response.messages;
      }
    });
  }

  var checkMessageStatus = function () {
    setInterval(function () {
      checkServerMessage().success(function (response) {
        if (response.status === 0) {
          refreshMessageStatus();
        }
      });
    }, _checkInterval);
  }

  var stripTags = function (body) {
    var div = document.createElement('div');
    div.innerHTML = body;
    return div.textContent || div.innerText || '';
  }

  var getMessageContent = function () {
    var str = '';
    for (var i = 0, l = _messages.length; i < l; i ++) {
      str += '<li><a href="/notifications.php?id=' + _messages[i].id + 
        '"><span class="header-message-icon"></span>' + stripTags(_messages[i].body) +'</a></li>';
    }

    return '<ul>' + str + '</ul><p><a class="detail-link" href="/notifications.php" class="pull-right">查看详情</a></p>';
  }

  refreshMessageStatus();
  checkMessageStatus();

  var $notiBadgeIcon = $notiBadge.find('.icon');
  var $badgePopover = $notiBadgeIcon.popover({
    container: 'body',
    html: true,
    trigger: 'manual',
    placement: 'bottom',
    animation: false,
    content: function () {
        var html = getMessageContent();
        return '<div class="popover-message noti-badge-message" id="js-popover-message">' + html + '</div>';  
    }
  });

  var _hoverTimer;
  var _hoverTimer2;
  var _popovered = false;
  $notiBadge.on('mouseenter', function() {
    if (_isInNotificationsPage || !_messages.length) return;
    clearTimeout(_hoverTimer2);
    !_popovered && $notiBadgeIcon.popover('show');
  });

  $notiBadgeIcon.on('mouseleave', function() {
    if (_isInNotificationsPage) return;
    clearTimeout(_hoverTimer);
    _hoverTimer = setTimeout(function() {
      $notiBadgeIcon.popover('hide');
    }, 300);
  }).on('click', function () {
    if (_isInNotificationsPage) return;
    window.location.href = '/notifications.php';
  });

  $badgePopover.on('shown.bs.popover', function () {
    if (_isInNotificationsPage) return;
    _popovered = true;
    var $popoverMessage = $('#js-popover-message');

    $popoverMessage.on('mouseenter', function () {
        clearTimeout(_hoverTimer);
    }).on('mouseleave', function () {
      _hoverTimer2 = setTimeout(function () {
        $notiBadgeIcon.popover('hide');
      }, 300);
    });
  }).on('hide.bs.popover', function () {
      _popovered = false;
  });
}

function driveProfileMenuEvent() {
  var $headerMenu = $('#js-header-menu');
  var $menuBar = $('#js-menu-bar');
  var $logoutForm = $('#logout');

  $headerMenu.on('mouseenter', function () {
    $menuBar.show();
  }).on('mouseleave', function () {
    $menuBar.hide();
  });

  $menuBar.on('mouseenter', function () {
    $(this).show();
  }).on('mouseleave', function () {
    $(this).hide();
  });

  $logoutForm.ajaxForm({
    'dataType': 'json',
    'success': function(response, status) {
      if (0 == response['status']) {
        console.log(response);
        if(response['redirect'] !== '') {
            window.location = response['redirect'];
        }else{
            window.location = '/index.php';
        }
      }
    }
  });

  driveMessage();
}

function addTsToHref(elem) {
    var href = elem.getAttribute('href');
    var connector = href.indexOf('?') > 0 ? '&' : '?';
    elem.setAttribute('href', href+connector+'ts='+new Date().getTime());
}

$(document).ready(function () {
  setUserGreeting(window.user_greeting || '');
  PrepareHeader($('#username'), kPageMessages['account_prompt'], '#login', '#logout', $('#authenticated'), $('#unauthenticated'), window.authenticated);

  if (window.authenticated == 1) {
    driveProfileMenuEvent();
  }
});

var postMessageHandler = {
  getBuildNo: function(cb){
      var ts = new Date().getTime();
      ts = ts - (ts % 60000);
      cb(ts);
  },   
  getUrlParam: function(key, cb){
      var url = new URL(window.location.href);
      cb(url.searchParams.get(key));
  },  
  getHeaderVisible: function(cb){
    cb($('#header').css('display') != 'none')
  },
  setHeaderVisible: function(visible, cb){
    var header = $('#header');
    if(!visible){
      header.slideUp(200, function () {
        $(window).trigger('resize');
      });
    }
    else{
      header.slideDown(200, function () {
        $(window).trigger('resize');
      });
    }
    cb(0)
  },
  gotoEditor: function(param, cb){
    var ui = param.ui || 'pro';
    var selectSize = param.selectSize;
    var theme = param.theme;
    var otherParam = param.otherParam;
    var url = '';
    if(ui === 'rich') url = '/animation/new?ui=rich&theme=bright&ts='+new Date().getTime();
    else if(ui === 'lite') url = '/animation/new?ui=lite&ts='+new Date().getTime();
    else if(ui=== 'pro') url = '/animation/new?&ts='+new Date().getTime();
    if(selectSize) url += '&selectsize=1';
    if(theme) url += ('&theme=' + theme[1]);
    if(otherParam) url += "&" + otherParam;
    location.href = url;
    cb(0)
  },
  exit: function(cb){
    location.href = '/member.php';cb(0)
  }
};

window.addEventListener('message', function(event){
  var sendBack = function(resposne){
    event.source.postMessage({
      to: 'mugeda',
      id: event.data.id,
      args: resposne
    }, event.origin)
  };
  if(event.data && event.data.from === 'mugeda'){
    var data = event.data;
    var fun = data.args[0];
    if(postMessageHandler[fun]){
      postMessageHandler[fun].apply(this, data.args.slice(1).concat([sendBack]))
    }
  }
});


$(window).scroll(function() {
    var yheight=window.pageYOffset; //滚动条距顶端的距离
     if(yheight>0){
        $(".global_header").css('box-shadow','0 0 1px #ddd')
     }else{
         $(".global_header").css('box-shadow','none')
     }
})

