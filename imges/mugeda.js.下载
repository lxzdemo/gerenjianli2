var mugedaContext = {};

// 生成二维码相关代码
function is_modern_browser() {
    if (navigator.userAgent.indexOf('Chrome') > -1 || navigator.userAgent.indexOf('Firefox') > -1 || navigator.userAgent.indexOf('Safari') > -1) {
        return true
    } else {
        return false
    }
}

function generatePreviewQrcode($qrcode, src, w, h, type) {
    var _w = w || 150;
    var _h = h || 150;
    var type;

    if (!type) {
        if (is_modern_browser()) {
            type = 'canvas';
        } else {
            type = 'div';
        }
    }

    var _connect = src.indexOf('?') > 0 ? "&" : "?";
    var _src = src + _connect + 't=' + (new Date() * 1);
    $qrcode.empty().qrcode({
        render: type,
        text: _src,
        correctLevel: 0,
        width: _w,
        height: _h
    });

};

function PrepareHeader(userBox, kLoginPrompt, loginFormSelector, logoutFormSelector, authenticatedView, unauthenticatedView, authenticated) {
    // toggleUserView(authenticatedView, unauthenticatedView, authenticated);

    $('#dialog-header').dialog({
        'autoOpen': false,
        'modal': true,
        'buttons': [{
            'text': kPageMessages['ok'],
            'class': 'dialog_button',
            'click': function() {
                $(this).dialog('close');
            }
        }]
    });

    var submitOptions = {
        'iframe': true,
        'dataType': 'json',
        'beforeSubmit': function(formData, jqForm, options) {
            var username = $(loginFormSelector + ' input[name=username]').val();
            var password = $(loginFormSelector + ' input[name=password]').val();
            if (!username || !password) {
                $('#dialog-header')
                    .text(kPageMessages['user_or_password_empty'])
                    .dialog('open');
                return false;
            }
            return true;
        },
        'success': function(response, status) {
            if (9 == response['status']) {
                $('#dialog-header')
                    .text(kPageMessages['need_verification'])
                    .dialog('open');
                return;
            } else if (12 == response['status']) {
                $('#dialog-header')
                    .text(kPageMessages['login_server_error'])
                    .dialog('open');
                return;

            } else if (0 != response['status']) {
                $('#dialog-header')
                    .text(kPageMessages['login_failed'])
                    .dialog('open');
                return;
            }

            setUserGreeting(response['user_greeting']);
            toggleUserView(authenticatedView, unauthenticatedView, true);
            if (response['jump_to']) {
                window.location = response['jump_to'];
            } else {
                window.location = '/workbench_new.php';
            }
        }
    }

    var $loginForm = $(loginFormSelector),
        https = $loginForm.find('input[name=__s]').val();

    if (https == 0) {
        submitOptions.iframe = false;
    }
    $(loginFormSelector).ajaxForm(submitOptions);

    // $(logoutFormSelector).ajaxForm({
    //     'dataType': 'json',
    //     'success': function(response, status) {
    //         if (0 == response['status']) {
    //             window.location = '/index.php';
    //         }
    //     }
    // });
}

function setUserGreeting(userGreeting) {
    //$('#user_greeting').html('<a href="/anilist.php" style="width: 0px">' + userGreeting + '</a>');
    $('#user_greeting').text(userGreeting);
    $('#user_greeting').click(function(){
      location.href='/workbench_new.php';
    });
}

function PrepareIndexPage(accessCodeBox, kShareCodePrompt) {
    accessCodeBox
        .on('focus', function() {
            var $this = $(this);
            if ($this.val() == kShareCodePrompt) {
                $this.val('');
            }
        })
        .on('blur', function() {
            var $this = $(this);
            if ($this.val() == '') {
                $this.val(kShareCodePrompt);
            }
        });
    $('#dialog_sample').dialog({
        'minHeight': 0,
        'autoOpen': false,
        'resizable': false,
        'width': 'auto',
        'modal': true,
        'dialogClass': 'mugeda-popup',
        // [Lucas] Clear its content to avoid annoying audio playback even after it is closed.
        'close': function(event, ui) {
            $('#dialog_sample').html("about:blank");
        }
    });
}

function openVideoPopup(title, video_id, type, locale) {
    var kVideos = [{
        'name': '/media/' + locale + '/mugeda_intro',
        'width': 640,
        'height': 360
    }, {
        'name': '/media/' + locale + '/01_QuickIntro',
        'width': 720,
        'height': 450
    }, {
        'name': '/media/' + locale + '/02_GettingStarted',
        'width': 720,
        'height': 450
    }, {
        'name': '/media/' + locale + '/03_Toolbar',
        'width': 720,
        'height': 450
    }, {
        'name': '/media/' + locale + '/04_Timeline',
        'width': 720,
        'height': 450
    }, {
        'name': '/media/' + locale + '/05_ContextMenu',
        'width': 720,
        'height': 450
    }, {
        'name': '/media/' + locale + '/06_Action',
        'width': 720,
        'height': 450
    }, {
        'name': '/media/' + locale + '/07_Mask',
        'width': 720,
        'height': 450
    }, {
        'name': '/media/' + locale + '/08_Symbol',
        'width': 720,
        'height': 450
    }, {
        'name': '/media/' + locale + '/09_Camera',
        'width': 720,
        'height': 450
    }, ];
    var kVideo = kVideos[video_id];

    if (type == 0) {
        var html_content = '<div><video width="' + kVideo.width + '" height="' + kVideo.height + '" controls="controls" autoplay="autoplay"><source src="' + kVideo.name + '.mp4"  type="video/mp4"/><source src="' + kVideo.name + '.ogv" type="video/ogg" />Your browser does not support the video tag.</video>';
    } else if (type == 1) {
        var html_content = '<div><video width="' + kVideo.width + '" height="' + kVideo.height + '" controls="controls" autoplay="autoplay"><source src="' + kVideo.name + '.mp4"  type="video/mp4"/><source src="' + kVideo.name + '.ogv" type="video/ogg" />Your browser does not support the video tag.</video>';
    }
    //setter
    $("#dialog_sample").dialog("option", "title", title);
    $('#dialog_sample').html(html_content);
    $('#dialog_sample').dialog('open');
}

function openExampleDialog(example_id, lang) {
    if (lang == 'en') {
        var kSamples = [{
            'crid': '589ee313 ',
            'width': 280,
            'height': 240
        }, {
            'crid': '55484534',
            'width': 280,
            'height': 240
        }, {
            'crid': '53c116e8  ',
            'width': 320,
            'height': 320
        }, {
            'crid': 'a01dab65',
            'width': 320,
            'height': 50
        }, {
            'crid': 'cb342be3',
            'width': 320,
            'height': 50
        }];
    } else {
        var kSamples = [{
            'crid': 'ab991f47 ',
            'width': 280,
            'height': 240
        }, {
            'crid': '13fef073',
            'width': 280,
            'height': 240
        }, {
            'crid': '6265594e  ',
            'width': 320,
            'height': 320
        }, {
            'crid': '7c44f641',
            'width': 320,
            'height': 50
        }, {
            'crid': '2aff568b',
            'width': 320,
            'height': 50
        }];
    }
    /*
        var kSamples=[
            {'crid':'3040bed7', 'width':649, 'height':79},
            {'crid':'06f223b3', 'width':320, 'height':480},
            {'crid':'b10376f7', 'width':640, 'height':100},
            {'crid':'be8f220d', 'width':640, 'height':480},
            {'crid':'c53573bc', 'width':480, 'height':80}
            ];
    */
    var creative = kSamples[example_id];
    // TODO(yangzh): use template.
    //$('#dialog_sample').html('');
    //$('#dialog_sample_content', '#dialog_sample').tmpl(creative).appendTo('#dialog_sample');
    var html_content = '<iframe src="/client/preview.html?id=' + creative['crid'] +
        '" width="' + creative['width'] + '" height="' + creative['height'] +
        '" frameborder="0" align="middle"></iframe>';
    $('#dialog_sample').html(html_content);
    $('#dialog_sample').dialog('open');
}

function getParam(name) {
    var url = window.location.search;
    var reg = new RegExp('(\\?|&)' + name + '=([^&?]*)', 'i');
    var arr = url.match(reg);
    if (arr) return arr[2];
}

function changeCreativeSize(height, width, element) {
    if (width > height) {
        var new_height = element.attr('width') * creative_height / creative_width;
        element.attr('height', new_height);
    }
}

function ConfirmDelete(e) {
    e.preventDefault();
    var targetUrl = $(this).attr("href");

    $('#dialog-confirm-deletion').dialog({
        'resizable': false,
        'modal': true,
        'buttons': [{
            'text': kPageMessages['confirm'],
            'class': 'dialog_button',
            'click': function() {
                window.location.href = targetUrl;
                $(this).dialog('close');
            }
        }, {
            'text': kPageMessages['cancel'],
            'class': 'dialog_button',
            'click': function() {
                $(this).dialog('close');
            }
        }]
    });
}

function PrepareSignupPage() {
    $('#signup_form').ajaxForm({
        'target': '#signup_ajax',
        'dataType': 'json',
        'beforeSubmit': function(formData, jqForm, options) {
            var username = $('#signup_form input[name=username]');
            var email = $('#signup_form input[name=email]');
            var password = $('#signup_form input[name=password]');
            var password2 = $('#signup_form input[name=password2]');
            var captcha = $('#signup_form input[name=captcha]');
            var tos = $('#signup_form input[name=tos]');
            allFields = $([])
                .add(username)
                .add(email)
                .add(password)
                .add(password2)
                .add(captcha)
                .add(tos);
            allFields.removeClass('ui-state-error');

            allFields.each(function(index, element) {
                $(this).siblings('span.msg').text('');
            });

            if (!username.val()) {
                updateTip(kPageMessages['error_username_empty'], username);
                return false;
            }
            if (!email.val()) {
                updateTip(kPageMessages['error_email_empty'], email);
                return false;
            }
            if (!password.val()) {
                updateTip(kPageMessages['error_password_empty'], password);
                return false;
            }
            if (password.val() != password2.val()) {
                updateTip(kPageMessages['error_password_mismatch'], password2);
                return false;
            }
            if (!captcha.val()) {
                updateTip(kPageMessages['error_captcha_empty'], captcha);
                return false;
            }
            if (!tos.is(':checked')) {
                updateTip(kPageMessages['error_did_not_agree_to_tos'], tos);
                return false;
            }
            $('*').css('cursor', 'wait');
            return true;
        },
        'success': function(response, status) {
            $('*').css('cursor', 'auto');
            if (0 == response['status']) {
                window.location = '/message_page.php?type=signup_confirm';
                return;
            }

            var message = response['error'];
            $('#dialog-signup-response').text(message).dialog({
                modal: true,
                buttons: [{
                    'text': kPageMessages['ok'],
                    'class': 'dialog_button',
                    'click': function() {
                        $(this).dialog('close');
                    }
                }]
            });
        }
    });
}

function updateTip(tip, field) {

    // TODO(Lucas): Remove the alert dialog and use tips
    // alert(kPageMessages['sherror']);
    var tipSpan = $(field).siblings('span.msg');
    if (tip == '')
        tipSpan.css('display', 'none');
    else {
        tipSpan.text(tip).addClass('ui-state-highlight');
    }

    setTimeout(function() {
        tipSpan.removeClass("ui-state-highlight", 1500);
    }, 500);

    field.focus();
}

function PrepareInvitationPage() {
    $('#invitation_form').ajaxForm({
        'target': '#invitation_ajax',
        'dataType': 'json',
        'beforeSubmit': function(formData, jqForm, options) {
            var first_name = $('#invitation_form input[name=first_name]');
            var last_name = $('#invitation_form input[name=last_name]');
            var email = $('#invitation_form input[name=email]');
            var phone = $('#invitation_form input[name=phone]');
            var business_name = $('#invitation_form input[name=business_name]');
            var business_site = $('#invitation_form input[name=business_site]');
            var reference_code = $('#invitation_form input[name=reference_code]');
            allFields = $([])
                .add(first_name)
                .add(last_name)
                .add(email)
                .add(phone)
                .add(business_name)
                .add(business_site)
                .add(reference_code);
            allFields.removeClass('ui-state-error');

            allFields.each(function(index, element) {
                $(this).siblings('span.msg').text('');
            });

            if (!first_name.val()) {
                updateTip(kPageMessages['error_first_name_empty'], first_name);
                return false;
            }
            if (!last_name.val()) {
                updateTip(kPageMessages['error_last_name_empty'], last_name);
                return false;
            }
            if (!email.val()) {
                updateTip(kPageMessages['error_email_empty'], email);
                return false;
            }
            if (!business_name.val()) {
                updateTip(kPageMessages['error_business_name_empty'], business_name);
                return false;
            }
            if (!business_site.val()) {
                updateTip(kPageMessages['error_site_empty'], business_site);
                return false;
            }
            $('*').css('cursor', 'wait');
            return true;
        },
        'success': function(response, status) {
            $('*').css('cursor', 'auto');
            if (0 == response['status']) {
                window.location = '/message_page.php?type=invite_confirm';
                return;
            }

            var message = response['error'];
            $('#dialog_invitation_response').text(message).dialog({
                modal: true,
                buttons: [{
                    'text': kPageMessages['ok'],
                    'class': 'dialog_button',
                    'click': function() {
                        $(this).dialog('close');
                    }
                }]
            });
        }
    });
}

function changeCaptcha() {
    $('#captchaimg').attr('src', '/captcha.php? ' + Math.random(1));
}

function onSubmitSignupForm() {
    $('#signup_form').submit();
}

function onSubmitInvitationForm() {
    $('#invitation_form').submit();
}

function renderThumbPic() {
    var creativeNodes = $.grep($('#creative_container').children(), function(n, v) {
        return (n.id != 'add_new_creative');
    });
    var creativeCount = creativeNodes.length;

    $.each(creativeNodes, function(index, item) {
        var imageElem = $(item).find('div.albumlist_pic img');
        var defaultW = 320;
        var defaultH = 50;
        if (!imageElem.length) {
            return false;
        }
        var $hideDiv = imageElem.prev('div');
        var imageSrc = $hideDiv.attr('src');
        var image = new Image()
        image.src = imageSrc;
        image.onload = function() {
            $hideDiv.parent().css('background-image', 'url(' + imageSrc + ')');
            imageElem.hide()
        };
    })
}

function removeAllPublishedUrl(crid) {
    if (!crid) return;

    $.ajax({
            url: '/api_publish_action.php',
            type: 'get',
            dataType: 'json',
            data: {
                action: 'removeAllPublish',
                crid: crid
            },
        })
        .done(function() {
            console.log("removeAllPublish success");
        })
        .fail(function() {
            console.log("removeAllPublish error");
        })
        .always(function() {
            console.log("removeAllPublish complete");
        });

}
function deleteCreatives(action) {
    if(action=='close'){
        $('#delete-confirm-dialog').dialog('close');
        $("div[data-checked='1']").each(function (i,v) {
            $(this).attr("data-checked",'0');
        });
        $("td input[name=childbox]:checked").each(function (i,v) {
            $(this).prop("checked", false);
        });
    }else{
        var crids=new Array();
        if($("#creative_container").is(":hidden") == true){
          $("td input[name=childbox]:checked").each(function (i,v) {
            var crid=$(this).parent().parent().attr("data-crid");
            $(this).parent().parent().remove();
            crids[i] = crid;
          });
        }else{
          $("div[data-checked='1']").each(function (i,v) {
            if($("#creative_container").is(":hidden") == true){
                var crid=$(this).parent().parent().attr("data-crid");
            }else{
                if(pageid && pageid== 'workbench_new'){
                    var crid=$(this).parents("div[name=creative_box]").attr("data-ref");
                }else{
                    var crid=$(this).parents("li[name=creative_box]").attr("data-ref");
                }

            }
            crids[i] = crid;
          });
        }
        updateState(crids,"deleteAll");
        $('#delete-confirm-dialog').dialog('close');
    }


}
function updateState(crids,action){
    action = action || '';
    $.post('/anilist_manager.php', {
            'action': 'update_state',
            'crid': crids
        },
        function(response) {
            if (response['status'] == 0) {
                if (action == "deleteAll") {
                    $(crids).each(function (i, v) {
                        if(pageid && pageid=='workbench_new') {
                            var folder_item_delete_checked = $('div#c_' + crids[i], '#creative_container').children('.folder_item_delete');
                            folder_item_delete_checked.show();
                            removeAllPublishedUrl(crids[i]);
                        }else{
                            var folder_item_delete_checked = $('li#c_' + crids[i], '#creative_container').children('.folder_item_delete');
                            folder_item_delete_checked.show();
                            removeAllPublishedUrl(crids[i]);
                        }

                    });
                }else{
                        var folder_item_delete_checked = $('li#c_' + crids, '#creative_container').children('.folder_item_delete');
                        folder_item_delete_checked.show();
                        folder_item_delete_checked.append('<span class="folder_item_delete_span">已删除!</span>');
                        $('li#c_' + crids, '#creative_container').children('.folder_checkbox_handle1').addClass("isdel");
                        $('li#c_' + crids, '#creative_container').children('.hover_check').attr("data-checked", "0");
                        removeAllPublishedUrl(crids);
                }
            }
        },
        'json'
    );
}

function deleteCreative(pageid, crid, state, type, tag, urid) {
    if (confirm("所有选中作品本身以及作品已发布的链接都将被删除，项目删除30天内，可在左下方「回收站」内恢复，确定删除吗？")) {
        $.post('/anilist_manager.php', {
                'action': 'delete',
                'crid': crid
            },
            function(response, status) {
                if (response['status'] == 0) {
                    if ('camplist' == pageid) {
                        //移除tr
                        $('tr#c_' + crid, '#creative_container').remove();

                    } else {
                        $('li#c_' + crid, '#creative_container').remove();
                    }
                    if ('anilist' == pageid || 'camplist' == pageid){
                        var toPage = $('#pagination li.active').attr('jp-data');

                        if (toPage) {
                            getCreatives({
                                toPage: Number(toPage)
                            });
                        } else {
                            getCreatives();
                        }
                        removeAllPublishedUrl(crid);
                    }

                }
            },
            'json');
    }
}

function redirectToTemplist() {
    $('#dialog_changetotpl').html(kPageMessages['jumping_to_templist']);
    window.location.href = '/templist.php';
}
function redirectToShareTemplist() {
    $('#dialog_changetotpl').html(kPageMessages['jumping_to_share_templist']);
    window.location.href = '/share_templist.php';
}

function submitAssociated(crid) {
    var $dialog = $('#dialog_submitAssociated');
    $dialog.dialog({
        resizable: false,
        autoOpen: false,
        modal: true,
        width: 500
    });
    $dialog.html(kPageMessages['submitAssociating']).dialog('open');

    var action = arguments[1] ? arguments[1] : 'add';

    $.get('/api_setcreativeattr.php', {
            attribute: 'associated',
            value: 1,
            crid: crid,
            action: action
        })
        .then(function(response) {
            if (response.status === 7) {
                $dialog.html(kPageMessages['error_associated']);
            } else if (response.status === 0) {
                if ($("#subinfo").text() == "取消提交") {
                    $("#subinfo").text("提交作品");
                } else {
                    $("#subinfo").text("取消提交");
                }
                $dialog.html(kPageMessages['success_associated']);
            } else {
                $dialog.html(kPageMessages['error_internal']);
            }
        }, function() {
            $dialog.html(kPageMessages['error_internal']);
        });
}

function changetotemplate(crid) {
    $('#dialog_changetotpl').dialog({
        'resizable': false,
        autoOpen: false,
        'modal': true,
        width: 500
    });
    $('#dialog_changetotpl').dialog('open');

    $.ajax({
            url: '/api_setcreativeattr.php',
            type: 'GET',
            data: {
                attribute: "convert",
                value: "template",
                crid: crid
            },
        })
        .done(function(res) {
            if (res && res.status == 0) {
                $('#dialog_changetotpl').html(kPageMessages['convert_success'] + '<a class="colorff2a00" href="javascript:redirectToTemplist()">' + kPageMessages['template_list'] + '</a>');
            } else {
                $('#dialog_changetotpl').html(kPageMessages['error_internal']);
            }
        })
        .fail(function() {
            console.log("error");
        })
        .always(function() {
            console.log("complete");
        });
}

function shareCreative(pageid, crid, type, aniType) {
    $('#dialog_share_error').dialog({
        'autoOpen': false,
        'modal': true,
        width: 570,
        'buttons': [{
            'text': kPageMessages['ok'],
            'class': 'dialog_button',
            'click': function() {
                $(this).dialog('close');
            }
        }]
    });
    shareDialogSwitchToInit(crid, type, aniType);
    $('#dialog_share').dialog('open');
}

function popupActionMenu(target) {
    if (mugedaContext.activeMask)
        mugedaContext.activeMask.hide();

    mugedaContext.activeMask = $(target.parentNode).find('.menu_mask');
    mugedaContext.activeMask.show();

    var hideFunc = function() {
        if (mugedaContext.activeMask) {
            mugedaContext.activeMask.hide();
            mugedaContext.activeMask = null;
        }

        window.removeEventListener('click', hideFunc);
    };
    window.addEventListener('click', hideFunc);
    window.event && window.event.stopPropagation();
}

function exportCreative(crid, type) {
    var path = "/map_exporter.php?crid=";
    if (type == 'pages') {
        path = "/pages_exporter.php?crid=";
    }
    // Dialog
    $('#export_dialog').dialog({
        'resizable': false,
        autoOpen: false,
        'modal': true,
        width: 500,
        buttons: [{
            'text': kPageMessages['save'],
            'click': function() {
                var export_response_frame = $('#export_response');

                if (export_response_frame[0]) {
                    export_response_frame.load(function() {
                        var responseText = export_response_frame.contents().find('body').text();

                        if (!/^\{.+\}$/.test(responseText))
                            return;

                        var result = JSON.parse(responseText);

                        if (result.status != 0) {
                            if (result.status == 14 && window.show_toplimit_win && result.name && result.type) {
                                window.show_toplimit_win(result.name, result.type);
                            } else {
                                alert(result.error);
                            }
                        }

                    }).attr('src', path + crid);

                } else {
                    window.location = path + crid;
                }

                $(this).dialog("close");
            }
        }, {
            'text': kPageMessages['cancel'],
            'click': function() {
                $(this).dialog("close");
            }
        }]
    });
    $('#export_dialog').dialog('open');
}

function getAccesscodeHelp() {
    // Dialog
    $('#help_dialog').dialog({
        'resizable': false,
        autoOpen: false,
        'modal': true,
        width: 400,
        buttons: [{
            "text": kPageMessages['ok'],
            'click': function() {
                $(this).dialog("close");
            }
        }]
    });
    $('#help_dialog').dialog('open');
}

function getCampaignTag(cid) {
    // Dialog
    $('#Tag_dialog' + cid).dialog({
        'resizable': false,
        autoOpen: false,
        'modal': true,
        width: 500,
        buttons: [{
            "text": kPageMessages['ok'],
            'click': function() {
                $(this).dialog("close");
            }
        }]
    });
    $('#Tag_dialog' + cid).dialog('open');
}

function shareDialogSwitchToInit(crid, type, aniType) {
    $.getJSON('/sharecode.php', {
            'crid': crid,
            'action': 'get',
            'type': type
        },
        function(json, textStatus, jqXHR) {
            if (0 != json['status']) {
                $('#dialog_share_error')
                    .text(kPageMessages['generic_error'])
                    .dialog('open');
                return;
            }
            if (json['share_code']) {
                shareDialogSwitchToShareCode(crid, json['share_code'], type, aniType);
            } else {
                shareDialogSwitchToPrivate(crid, type, aniType);
            }
        });
    $('#dialog_share').attr('state', 'init');
}

function shareDialogSwitchToShareCode(crid, share_code, type, aniType) {
    $('.sharecode', '#dialog_share').text(share_code);
    var url = $("#qrurl").attr('url');

    if ('canvas' === aniType) {
        url = url.replace('preview_css3.html', 'preview.html');
    }

    url += share_code;

    $('#qrurl').html(url);
    $('#qrcodeCanvas').html('');
    $("#qrcodeCanvas").qrcode({
        width: 100,
        height: 100,
        color: '#3a3',
        text: url
    });


    var button = $('#share_button', '#dialog_share').text(kPageMessages['clear']);
    button.off('click');
    button.on(
        'click',
        function() {
            $.getJSON('/sharecode.php', {
                    'crid': crid,
                    'action': 'remove'
                },
                function(json, textStatus, jqXHR) {
                    if (0 != json['status']) {
                        $('#dialog_share_error')
                            .text(kPageMessages['generic_error'])
                            .dialog('open');
                        return;
                    }
                    shareDialogSwitchToPrivate(crid, type, aniType);
                });
        });
    $('#dialog_share').attr('state', 'sharecode');
}

function shareDialogSwitchToPrivate(crid, type, aniType) {
    $('.sharecode', '#dialog_share').text('');
    var button = $('#share_button', '#dialog_share').text(kPageMessages['request']);
    button.off('click');
    button.on(
        'click',
        function() {
            $.getJSON('/sharecode.php', {
                    'crid': crid,
                    'action': 'request',
                    'type': type
                },
                function(json, textStatus, jqXHR) {
                    if (0 != json['status']) {
                        $('#dialog_share_error')
                            .text(kPageMessages['generic_error'])
                            .dialog('open');
                        return;
                    }
                    shareDialogSwitchToShareCode(crid, json['share_code'], type, aniType);
                });
        });
    $('#dialog_share').attr('state', 'private');
}

function PrepareAnieditPage() {
    $(window.top).resize(function() {
        var windowHeight = $(window).height();
        var headerHeight = $('#header').height();
        $('iframe#editor').css('height', (windowHeight - headerHeight) + 'px');
    });
    $(window.top).resize();
}

// function PrepareHelpPage() {
//  $('#help_form').ajaxForm({
//      'target': '#help_ajax',
//      'dataType': 'json',
//      'beforeSubmit': function(formData, jqForm, options) {
//          var email = $('#help_form input[name=email]');
//          var question = $('#help_form textarea[name=question]');
//          var captchaitem = $('#help_form input[name=captcha_code]');
//          var captcha = captchaitem.val();
//          allFields = $([])
//          .add(email)
//          .add(question);
//          allFields.removeClass('ui-state-error');

//          allFields.each(function(index, element) {
//              $(this).siblings('span.msg').text('');
//          });
//          captchaState = false;
//          checkCaptcha(captcha);

//             // TODO: Add more field validation.
//          if(!captchaState){
//                 // TODO: Add message for captcha
//                 updateTip(kPageMessages['shcaptcha'], captchaitem);
//              return false;
//          }
//             else
//                 updateTip('', captchaitem);

//          var pattern  = /^([a-zA-Z0-9]+[\_|\.]?)+@(?:([a-zA-Z0-9]+[\_|\.]?)+?)\.([a-zA-Z0-9]+[\_|\.]?)+$/i;
//          if(!pattern.exec(email.val()))
//          {
//              updateTip(kPageMessages['shemailerr'], email);
//              return false;
//          }

//          if (!email.val()) {
//              updateTip(kPageMessages['error_email_empty'], email);
//              return false;
//          }
//             updateTip('', email);

//          if (!question.val()) {
//              updateTip(kPageMessages['error_question_empty'], question);
//              return false;
//          }
//             updateTip('', question);

//          $('*').css('cursor', 'wait');
//          return true;
//      },
//      'success': function(response, status) {
//          $('*').css('cursor', 'auto');
//          if (0 == response['status']) {
//              window.location = '/message_page.php?type=help_confirm';
//              return;
//          }

//          var message = response['error'];
//          $('#dialog-help-response').text(message).dialog({
//              modal: true,
//              buttons: [{
//                  'text': kPageMessages['ok'],
//                  'class': 'dialog_button',
//                  'click': function() {
//                      $(this).dialog('close');
//                  }
//              }]
//          });
//      }
//     });

//  $('#dialog_sample').dialog({
//      'autoOpen': false,
//      'resizable': false,
//      'width': 'auto',
//      'modal': true,
//      'dialogClass': 'mugeda-popup',
//      // [Lucas] Clear its content to avoid annoying audio playback even after it is closed.
//      'close': function(event, ui) {
//          $('#dialog_sample').html("about:blank");
//      }
//  });

//  $('#accordion').accordion();
// }

function onSubmitHelpForm() {
    $('#help_form').submit();
}

function PrepareExportPage(kColumns, lang_path) {
    $('#export_table').hide();
    $('#loading').show();
    $.getJSON('/export_manager.php', {},
        function(response_json) {
            if (0 != response_json['status']) {
                alert('wrong');
                return;
            }
            var aaData = [];
            var json_data = response_json['exports'];
            var entry_count = json_data.length;
            var title = null;
            var creation_time = null;
            var finish_time = null;
            var status = null;
            for (var i = 0; i < entry_count; ++i) {
                if (json_data[i]['title']) {
                    title = json_data[i]['title'];
                } else {
                    title = kPageMessages['unknown_title'];
                }
                if (json_data[i]['creation_time']) {
                    creation_time = $.timeago(
                        new Date(json_data[i]['creation_time'] * 1000).toISOString());
                } else {
                    creation_time = kPageMessages['not_available'];
                }
                if (0 == json_data[i]['status']) {
                    if (json_data[i]['finish_time']) {
                        finish_time = $.timeago(
                            new Date(json_data[i]['finish_time'] * 1000).toISOString());
                    } else {
                        finish_time = kPageMessages['not_available'];
                    }
                    status = finish_time +
                        '&nbsp;<a href="/tmpfile.php?rid=' +
                        json_data[i]['temp_fs_ref_id'] + '">' + kPageMessages['download'] + '</a>';
                } else if (1 == json_data[i]['status']) {
                    status = kPageMessages['status_maybe_obsolete'] +
                        '&nbsp;<a href="/tmpfile.php?rid=' +
                        json_data[i]['temp_fs_ref_id'] + '">' + kPageMessages['download'] + '</a>';
                } else if (2 == json_data[i]['status']) {
                    status = kPageMessages['status_not_done'];
                }

                if ('ExportToMap' == json_data[i]['method']) {
                    method = kPageMessages['method_map'];
                }
                aaData.push([title, creation_time, status, method]);
            }
            $('#export_table').dataTable({
                'oLanguage': {
                    'sUrl': lang_path + '/dataTables.txt'
                },
                'sPaginationType': 'full_numbers',
                'bJQueryUI': true,
                'aoColumns': [{
                    'sTitle': kColumns[0],
                    'sClass': 'title'
                }, {
                    'sTitle': kColumns[1],
                    'sClass': 'creation_time'
                }, {
                    'sTitle': kColumns[2],
                    'sClass': 'status'
                }, {
                    'sTitle': kColumns[3],
                    'sClass': 'method'
                }],
                'aaData': aaData
            });
            $('#loading').hide();
            $('#export_table').show();
        });
}


function publish(crid) {
    $('.publish').toggle();
    if ($('.publish').css('display') == 'block') {
        var frame = $(".draft iframe");
        var w = $(frame).attr('width');
        var h = $(frame).attr('height');
        $("#str_load").css('visibility', 'visible')
        window.location.href = "#publish";
        $.ajax({
            type: "POST",
            url: "/json.php",
            data: {
                action: 'getShareCode',
                crid: crid
            },
            success: function(response) {
                if (response.error == "Ok") {
                    $("#str_load").css('visibility', 'hidden')
                    var pubcode = '<iframe src="https://www.mugeda.com/client/preview.html?id=' + response.share_code + '" width="' + w + '" height="' + h + '" frameborder="0" align="middle"></iframe>';
                    $('#publish_code').text(pubcode);
                }
            }
        });
    }
}

function checkCaptcha(captcha) {
    $.ajax({
        type: "POST",
        async: false,
        url: "/json.php",
        data: {
            'action': 'captchaCheck',
            'captcha': captcha
        },
        success: function(response) {
            if (response.error == "Internal error.:error_captcha_invalid") {
                captchaState = false;
            } else {
                captchaState = true;
            }
        }
    });
}

function reloadImageSrc(image, force) {
    if (force) {
        image.src = $(image).prev().attr('src');
        image.onload = null;
    }
}


// find password
// captcha , username
function FindPsw() {
    $('#findpsw_form').ajaxForm({
        'target': '#findpsw_form',
        'dataType': 'json',
        'beforeSubmit': function(formData, jqForm, options) {
            var captcha = $('#findpsw_form input[name=captcha_code]');
            var username = $('#findpsw_form input[name=username]');
            if (!username.val()) {
                alert('ass');
                updateTip(kPageMessages['error_username_empty'], username);
                return false;
            }

            if (!captcha.val()) {
                $("#captcha_code_tip").html("<img src=\"images/reg/reg_prompt.png\" />" + kPageMessages['error_captcha_empty']).show();
                updateTip(kPageMessages['error_captcha_empty'], captcha);
                return false;
            }

        },
        'success': function() {}
    });
}

var timer;
var start_timer = function(a, b) {
    timer = setTimeout(otherWay, 600, a, b);
}

var stop_timer = function(a) {
    clearTimeout(timer);
}

function otherWay(crid, tags) {
    if (tags != '') {
        $("#edit" + crid).show();
        $("#editimg" + crid).show();
    }
}

function in_array(stringToSearch, arrayToSearch) {
    for (s = 0; s < arrayToSearch.length; s++) {
        thisEntry = arrayToSearch[s].toString();
        if (thisEntry == stringToSearch) {
            return true;
        }
    }
    return false;
}

function selectAll(sel) {
    sel.focus();
    sel.select();
}


var getCategory = function() {
    //得到关键词，得到分类词
    $.ajax({
            url: '/api_keywords.php',
            type: 'GET',
            async: false,
            data: {
                action: 'keyword',
                perpage: 100,
                t: (new Date() * 1)
            },
        })
        .done(function(res) {
            if (res && res.status == 0) {

                var _category = [];

                $.each(res.list, function(index, val) {
                    var obj = {
                        keyword: ''
                    }
                    obj.keyword = val.keyword;
                    if (obj.keyword != "爱心公益" && obj.keyword != "卡通动漫" && obj.keyword != "邀请函" && obj.keyword != "热门案例" && (obj.keyword.indexOf('模板') < 0)) {
                        _category.push(obj);
                    }
                });

                _category.push({
                    keyword: "邀请函"
                });

                // $('#addtospace_catelog').html($('#addtospace_option').tmpl({category:_category}));

            } else {
                // $('#casesBox').html(kPageMessages.server_error);
            }
        })
        .fail(function() {
            // $('#casesBox').html(kPageMessages.server_error);
        });
}

var bind_uploadimg_events = function() {

    // var $js_uploadpic_form = $('#js-uploadpic-form');

    var readFile = function() {
        var file = this.files[0];

        var $fileValue = $('#upload_thumb').val() + '?time=' + (new Date() * 1);
        var filters = {
            "jpeg": "/9j/4"
                // "gif"   : "R0lGOD",
                // "png"   : "iVBORw"
        }

        var validateImg = function(data) {
            var pos = data.indexOf(",") + 1;
            for (var e in filters) {
                if (data.indexOf(filters[e]) === pos) {
                    return e;
                }
            }
            return null;
        }

        if ($fileValue) {
            //用size属性判断文件大小不能超过500Kb
            if (file.size > 0.05 * 1024 * 1024) {
                alert('你上传的文件大于50Kb，请上传更小的图片');
            } else {
                var reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(e) {
                    var res = this.result;
                    var maxWidth = 0;
                    if (validateImg(res)) {
                        $('.upload_img').attr('src', res);
                        // $('input[name="image_url"]').val('');
                    } else {
                        alert('上传的文件不是指定的格式，请重新选择');
                    }
                }
            }
        } else {
            // $jsUploadBtn.addClass('hidden');
        }
    }

    $('#upload_thumb').bind('change', readFile);

    $('#upload_img_btn').on('click', function(e) {
        e.preventDefault();
        $('#upload_thumb').click();
    });

    $('#confirm_commit').click(function(event) {
        event.preventDefault();

        $('#fill_info').ajaxForm({
            type: 'POST',
            // iframe: true,
            async: false,
            url: '/xueyuanjiang/submit_creative.php?action=submit_creative',
            success: function(res) {
                if (res && res.status == 0) {
                    generatePreviewQrcode($('#commit_qrcode'), $('#fill_info textarea[name="url"]').val(), 200, 200);
                    $('.info_panel').hide();
                    $('.qrcode_panel').show();
                } else {
                    $('#fill_info_tip').html('<span style="color:#f66526">你提交的作品信息不全或有误，请检查后重试（错误：' + res.error + '）</span>');
                    console.log('提交作品时遇到了错误：' + res.error);
                }
            },
            error: function(response) {
                $('#fill_info_tip').html('没有提交成功，请稍候再试');
            }
        }).submit();

    });
}

var bignumber = function(number) {
    var _num = parseInt(number, 10);

    if (locale == 'zh_CN') {
        var wan = parseInt(_num / 10000, 10);
        var yi = 0;
        var num = 0;

        if (wan < 100) {
            //小于100万时显示pv本身
            return _num;
        } else {
            //大于100万
            if (wan < 1000) {
                //大于100万，小于1000万，用2位小数
                num = (_num / 10000).toFixed(2);
                return (num + '万');
            } else if (1000 <= wan && wan < 10000) {
                //大于1000万，小于10000万(1亿)，用整数万
                num = parseInt(_num / 10000, 10);
                return (num + '万');
            } else {
                //大于10000万，进位成亿，用3位小数
                yi = (_num / 100000000).toFixed(3);
                return (yi + '亿');
            }

        }
    } else if (locale == 'en') {
        var v_thousand = 0;
        var v_million = 0;
        v_thousand = parseInt(pv / 1000, 10);
        if (v_thousand > 0) {

            if (v_thousand > 999) {
                // 大于1000 000时显示百万M
                v_million = parseInt(pv / 1000000, 10);
                return (v_million + 'M');
            } else {
                //其他显示xxx千
                return (v_thousand + 'K');
            }
        } else {
            // 不到万，显示本身
            return pv;
        }
    }
}

function renderBreadNav(res) {
    //面包屑导航
    var foldername = '';
    switch (res.type) {
        case 'animation':
            foldername = 'H5作品';
            break;
        case 'article':
            foldername = '图文作品';
            break;
        case 'chart':
            foldername = '图表作品';
            break;
        case 'video':
            foldername = '视频作品';
            break;
        default:
            break;
    }
    $('#bread-nav-wrapper').html('');
    if(!res.folder_tree) {
    } else {
        $('#bread-nav-wrapper').append('<a onclick="switchCreativeType(\'' + res.type + '\')"><span id="rootFolder" style="color:#606266 ">' + foldername + '</span></a>');
        res.folder_tree.forEach(function(folder) {
            $('#bread-nav-wrapper').append(' > <a onclick="enterCreativesFolder(\'' + folder.id + '\', ' + folder.parent_id + '\', \'' + res.type + '\')"><span style="color: #303133 ">' + folder.name + '</span></a>');
        });
    }
}

function renderAnilistCreatives(res, SubAccountsCreatives) {
    if(res.type !== ''){
        var creative_type = res.type;
    }
    var $container = $('#creative_container');
    var $container1 = $('#creative_container1');
    var $breadnav = $('#breadNavWrapper');
    // $('.creative_container_lazyload').remove();
    var folderId = res.folderId;
    var parentNodeId = res.parentNodeId;
    if (res.status !== 0) {
        $container.html('<div class="nocontent">' + kPageMessages['noContent'] + '</div>');
        return;
    }

    var creatives = res.creatives;
    var creativeCount = creatives.length;
    var use_filter_sign = $('#filter').attr('use_filter');

    var params = '?ts='+new Date().getTime();
    var this_folder_id = ($container.attr('this_folder_id') == 0) ? "" : ('&folder_id=' + $container.attr('this_folder_id'));
    params += this_folder_id;
    if(creative_type == "chart"){
        var newCreativeStr = ''
            +  '<li id="add_new_creative" style="margin-left: 48px;">'
            +    '<a href="/chart/new">'
            +      '<img src="/images/anilist/new_creative1.png" >'
            +      '<div style="margin-top: 18px">创建作品</div>'
            +    '</a>'
            +  '</li>';
    }else if(creative_type == "video"){
        var newCreativeStr = ''
            +  '<li id="add_new_creative" style="margin-left: 48px;">'
            +    '<a href="/video/new">'
            +      '<img src="/images/anilist/new_creative1.png" >'
            +      '<div style="margin-top: 18px">创建作品</div>'
            +    '</a>'
            +  '</li>';
    } else{
        // 创建作品时的弹窗
        var newCreativeStr = ''
            +  '<li id="add_new_creative" style="margin-left: 48px;">'
            +    '<a href="#" onclick="var btn = $(\'.main_r.rich #add_new_creative a\')[0]; if(btn) {$(\'.main_r.rich #add_new_creative a\').attr(\'href\', \'animation/new?ui=rich&amp;theme=bright\'); return true;}  else { $(\'#new-creative-dialog\').dialog({width:550,height:380,modal: true,title:\'\'}).show();}">'
            +      '<img src="/images/anilist/new_creative1.png" >'
            +      '<div style="margin-top: 18px">创建作品</div>'
            +    '</a>'
            +  '</li>';
    }

    // $(\'#new-creative-dialog\').parent().css(\'border\',\'1px solid #ee7700\').css(\'box-shadow\', \'0px 0px 3px 3px #ddd\');

    var titleStr = ''
        +  '<li id="title_info">'
        +  '<div style="width:44px;"><input type="checkbox"></div>'
        +  '<div style="width:44px;">序号</div>'
        +  '<div class="albumlist_conn"><div style="width:10%;">名称</div>'
        +  '<div style="width: 10%;">最后版本时间</div></div>'
        +  '<div style="width:10%;">状态</div>'
        +  '<div style="width:10%;">数据</div>'
        +  '<div style="width: auto;">操作</div>'
        +  '</li>';
    if (creativeCount <= 0) {
        if (use_filter_sign == 'true' || folderId == -1 || parentNodeId == -1) {
            $container.html('<div class="nocontent">' + kPageMessages['noContent'] + '</div>');

        } else {
            $container.html('<p style="text-align: center"><img src="/images/anilist/zanwushuju.png" height="189px"></p>' +
                '<p style="text-align: center;color: #C5C9D1;font-size: 16px;margin-top: -33px;">暂无数据...</p>');
            $('.table_box th').remove();
            $container1.html('<p style="text-align: center"><img src="/images/anilist/zanwushuju.png" height="189px"></p>' +
                '<p style="text-align: center;color: #C5C9D1;font-size: 16px;margin-top: -33px;">暂无数据...</p>');
        }

        creative_paginator(1);
    } else {
        $.each(creatives, function(i, creative) {
            if (creative.update_time) {
                if (creative.update_time.sec) {
                    creative.update_time = new Date(creative.update_time.sec * 1000).toISOString();
                }
            }

            creative.pv = bignumber(creative.pv);

            if ('noleftbar' === window.ui || (SubAccountsCreatives && SubAccountsCreatives == 'SubAccountsCreatives') || parentNodeId == -1 || folderId == -1) {
                creative.SubAccountsCreatives = true
            }

        });
        if (use_filter_sign == 'true' || folderId == -1 || parentNodeId == -1) {
            $container.html($('#creative').tmpl(creatives));
        } else {
            if(creative_type != 'article'){
                $container.html($('#creative').tmpl(creatives));
                $container1.html($('#creative1').tmpl(res));
                $breadnav.html($('#breadNavWrapper').tmpl(res));
                $('#breadNavWrapper').css('display','block');
            }else{
                if(creatives.length == 0){
                    $container.html('<p style="text-align: center">暂无数据</p>');
                    $breadnav.html($('#breadNavWrapper').tmpl(res));
                    $('#breadNavWrapper').css('display','block');
                }else{
                    $container.html($('#creative').tmpl(creatives));
                    $container1.html($('#creative1').tmpl(res));
                    $breadnav.html($('#breadNavWrapper').tmpl(res));
                    $('#breadNavWrapper').css('display','block');
                }

            }
        }

        // 删除触发删除按钮的显示
        $container.find('.folder_checkbox_handle1 input').on('click', function () {
            var n = $container.find(".folder_checkbox_handel_checked1").length;
            if (n > 0) {
                $('#delete_all').html('<img src="/images/anilist/del_sel.png"><u>删除</u>').attr('delete_all',true);
            } else if (n == 0) {
                $('#delete_all').html('<img src="/images/anilist/del.png"><u>删除</u>').attr('delete_all',false);
            }
        });

        if ($('#pagination').attr('initPagination') == 'true') {
            // 修正只有pages没有total_pages的情况
            if (!res.total_page && res.pages) {
                res.total_page = res.pages;
            }

            creative_paginator(res.total_page);
        } else if($('#pagination').attr('initPagination') !== 'click'){
            // 修正只有pages没有total_pages的情况
            if (!res.total_page && res.pages) {
                res.total_page = res.pages;
            }

            creative_paginator(res.total_page);
        }
        // 更新时间
        $('abbr.timeago').timeago();

        // 缩略图
        if (res.creatives.length > 0) {
            renderThumbPic();
        }

        // Delete needs to be confirmed.
        $('.need_delete_confirmation').click(ConfirmDelete);
    }

    if (use_filter_sign == 'true') {
        $('.folder_checkbox ').hide();
    } else {
        $('.folder_checkbox ').show();
        initDraggable();
    }

    $('.tooltip-trigger').tooltip({
        tooltipClass: "custom_tooltip_ui",
        hide: { duration: 100 },
        trigger: "hover"
    }).click(function() {
        $('.tooltip-trigger').trigger('blur');
    });

    $('#pagination').attr('initPagination', 'false');
}

function creative_paginator(totalPages, callback){
	if (totalPages == 0) {
		totalPages = 1;
	}
	// $.jqPaginator('#pagination', {
	//         totalPages: totalPages,
	//         visiblePages: 5,
	//         currentPage: 1,
	//         prev: '<li class="prev"><a href="javascript:void(0)"><< 向前</a></li>',
	//         next: '<li class="next"><a href="javascript:void(0)">向后 >></a></li>',
	//         page: '<li class="page"><a href="javascript:void(0)">{{page}}</a></li>',
	//         onPageChange: function (num, type) {
	//         	if (type != 'init') {
     //                if(!callback){
    	// 				if ($('#filter').attr('use_filter') == 'true'){
    	// 					getSubAccountsCreatives({toPage: num});
    	// 				} else {
     //                        getCreatives({"toPage": num})
    	// 				}
     //                }else if(typeof callback === "function"){
     //                    callback({"toPage": num})
     //                }
	// 			}
    //
	//         }
	//     });

    // var $pagination = $('#pagination');
    // var defaultOpts = {
    //     totalPages: totalPages,
    //     visiblePages: 4,
    //     first: false,
    //     prev: "<",
    //     next: ">",
    //     last: false,
    // };
    // $pagination.twbsPagination(defaultOpts);
    // var currentPage = 1;
    // $pagination.twbsPagination('destroy');
    // $pagination.twbsPagination($.extend({}, defaultOpts, {
    //     startPage: currentPage,
    //     totalPages: totalPages
    // })).on('page', function (event, page) {
    //
    //                    if(!callback){
    //     				if ($('#filter').attr('use_filter') == 'true'){
    //     					getSubAccountsCreatives({toPage: page});
    //     				} else {
    //                            getCreatives({"toPage": page})
    //     				}
    //                    }else if(typeof callback === "function"){
    //                        callback({"toPage": page})
    //                    }
    //
    // });
    $('#pagination').pagination({
        items: totalPages,
        itemOnPage: 6,
        currentPage: 1,
        cssStyle: '',
        prevText: '<span aria-hidden="true" >&lt;</span>',
        nextText: '<span aria-hidden="true" >&gt;</span>',
        onInit: function () {
        },
        onPageClick: function (page, evt) {
            $('#pagination').attr('initPagination', 'click');
            if(!callback){
                if ($('#filter').attr('use_filter') == 'true' || pageid == 'articlelistchild' || pageid == 'anilistchild'){

                  getSubAccountsCreatives({toPage: page});
                } else {
                    // var isRich =  $('.main_r').hasClass('rich');
                    var cpp = 16;
                    getCreatives({"toPage": page,'cpp':cpp}, creativeType);
                    $("#append_page").empty();
                    $('#pagination').show();
                    var html = '<div id="append_page" class="append_page">到第 <input type="text" id="page_index" style="width: 22px;height: 22px"> 页</div>';
                    $('#pagination').append(html);

                }
            }else if(typeof callback === "function"){
                callback({"toPage": page})
                $("#append_page").empty();
                $('#pagination').show();
                var html = '<div id="append_page" class="append_page">到第 <input type="text" id="page_index" style="width: 22px;height: 22px"> 页</div>';
                $('#pagination').append(html);
            }
        }
    });

	if (totalPages > 1) {
	    $("#append_page").empty();
        $('#pagination').show();
	    var html = '<div id="append_page" class="append_page">到第 <input type="text" id="page_index" style="width: 22px;height: 22px"> 页</div>';
        $('#pagination').append(html);
	} else {
		$('#pagination').hide();
	}
}

function requestCreatives(data,doserach) {
    if(data.user_folder === undefined && use_folder == '1'){
        data.use_folder = use_folder;
    }
    if(circle_id != ''){
        data.circle_id = circle_id;
    }
    $('#creative').attr('data-folderid',data.folder_id);
    $.ajax({
            url: '/creatives.php',
            type: 'get',
            dataType: 'json',
            data: data,
        })
        .done(function(res) {
            if (!res) return;
            if (res && res.status == 0) {
                // res.toPage = 1;
                res.folder_id= data.folderId;
                res.parentNodeId = data.parentNodeId;
                $('#creative_container').empty();
                $('#creative').show();
                if(data.type === 'article') {
                    $('#list_img').click();
                } else {
                    $('#chart_img').click();
                }
                renderAnilistCreatives(res);
                renderBreadNav(res);
                $('.nav-item').attr('data-clickable','1');

                if (window.find_creatives_type) {
                    window.history.pushState({}, window.title, '/anilist.php');
                    window.find_creatives_type = '';
                }
                if(res.count === 0 && doserach === 1){
                    $("#selecontent").text("未找到作品，请重新搜索");
                    $("#selectmodal").modal('show');
                }

            } else {
                $container.html('<div class="nocontent">' + kPageMessages['noContent'] + '</div>');
                creative_paginator(1);
            }
        });
}

function getCreatives(param, type) {
    if (!type) {
        type = 'animation';
    }
    var toPage = 1;

    if (param && param.toPage) {
        toPage = param.toPage
    }
    // $('#creative_container').html('<div class="creative_container_lazyload"><span><img src="/client/res/loading.gif" /><br/> ' + kPageMessages['loading'] + '</span></div>');

    var cppPlaceHolder = 0;
    var sentData = {
        state: 'all',
        type: type,
        page: toPage
    };
    if(param.user_folder !== undefined){
        sentData.user_folder = param.user_folder;
    }

    if ($('#filter').attr('use_filter') == 'true' || pageid == 'anilistchild') {
        sentData._urid = $('#user_selector').attr('_urid');
    }
    var parentNodeId = myAnilistStore.parent_id;
    sentData.folder_id = myAnilistStore.folder_id;
    var $container = $('#creative_container');
    var containerWidth = $container.width();
    // var placeHolder = folder_id==0 ? 0 :1;//根据当前文件夹层级确定数量
    // var cpp = 2 * parseInt(Math.floor(containerWidth / 199), 10) - placeHolder;
     // var cpp = 2 * parseInt(Math.floor(containerWidth / 800), 10) - cppPlaceHolder;//旧的
     // if(cpp < 0)
     //     cpp = 10;

    if(param.cpp == ""){
        sentData.cpp = 16;
    }else{
        sentData.cpp = param.cpp;
    }


    // perpage = perpage+cpp;
    // sentData.perpage = perpage;
    // console.log(perpage)
    var $publishSelect = $('select[name="publish_status"]');
    if ($publishSelect[0]) {
        var selectedPublishStatus = $publishSelect.val();
        if (selectedPublishStatus != 2) {
            sentData.publish_status = selectedPublishStatus;
        }
    }

    if ('noleftbar' === window.ui) {
        sentData.circle_id = 'default';
        delete sentData.folder_id;
    }

    // var _tag = $('select[name=tag]').val();
    var _tag = 'title';
    sentData.tag = _tag;

    if (_tag == 'title') {
        sentData.keyword = $('#search_user').val();
        if(sentData.keyword !== ""){
            sentData.user_folder = 0;
        }
    } else if (_tag == 'size') {
        sentData.keyword_height = $('#search_height').val();
        sentData.keyword_width = $('#search_width').val();
    }

    // sentData.folderId = folderId;
    sentData.parentNodeId = parentNodeId;

    if(pageid == 'anilistchild' || pageid == 'articlelistchild'){
        getSubAccountsCreatives();
    }else{
        if(param && param.dosearch === 1){
            requestCreatives(sentData,1);
        }else{
            requestCreatives(sentData,0);
        }
    }
}

var getSubAccountsCreatives = function(param,urid) {
    param = param || {}
    var sentData = {
        order_by: 'update_time'
    };

    var $container = $('#creative_container');
    // $container.html('<div class="creative_container_lazyload"> <span> <img src="/client/res/loading.gif" /> <br/> ' + kPageMessages['loading'] + '</span> </div>');

    var containerWidth = $container.width();
    // var _cpp =2 * parseInt(Math.floor(containerWidth / 600), 10);
    if(param.cpp && param.cpp!==''){
        sentData.perpage = param.cpp;
    }else{
        sentData.perpage = 16;
    }

    //var _cpp = 17;

    sentData.page = param.toPage ? param.toPage : 1;
    sentData.type = creativeType;
    var _type = $('#filter').data('type');

    if ('associated' === _type) {
        sentData.account = _type;
    }
    if(urid){
        sentData.urid =urid;
    }else{
        sentData.urid = $('#h5_child').attr('_urid');
    }

    // sentData.search_by = $('select[name=tag]').val();;
    sentData.search_by = 'title';

    if (sentData.search_by == 'title') {
        sentData.keyword = $('#search_user').val();
    } else if (sentData.search_by == 'size') {
        sentData.keyword_height = $('#search_height').val();
        sentData.keyword_width = $('#search_width').val();
    }

    var $publishSelect = $('select[name="publish_status"]');
    if ($publishSelect[0]) {
        var selectedPublishStatus = $publishSelect.val();
        if (selectedPublishStatus != 2) {
            sentData.publish_status = selectedPublishStatus;
        }
    }
    $.ajax({
            url: '/api_creatives.php',
            type: 'get',
            dataType: 'json',
            data: sentData,
        })
        .done(function(res) {
            renderAnilistCreatives(res, 'SubAccountsCreatives');
        })
        .fail(function() {});
}

var request_preview_url_by_crid = function(crid, ele, w, h){
    var type;
    var _preview_url = window.location.origin + '/client/preview_css3.html?id=';
    var width = w || 115;
    var height = h || 115;

    if (!type) {
        if (is_modern_browser()) {
            type = 'canvas';
        } else {
            type = 'div';
        }
    }

    $.getJSON('/sharecode.php', {
        'crid': crid,
        'action': 'get',
        'type': type
    }, function(json, textStatus, jqXHR) {
        if (json.status == 0) {
            if (json.share_code) {
                generatePreviewQrcode(ele, _preview_url + json.share_code, width, height);
            } else {
                $.getJSON('/sharecode.php', {
                    'crid': crid,
                    'action': 'request',
                    'type': type
                }, function(json, textStatus, jqXHR) {
                    generatePreviewQrcode(ele, _preview_url + json.share_code, width, height);
                })
            }
        }

    });
}

var request_preview_url = function(ele, w, h) {
    var crid = getParam('crid');
    request_preview_url_by_crid(crid, ele, w, h)
}

function parseUA() {
    var u = navigator.userAgent;
    var u2 = navigator.userAgent.toLowerCase();
    return { //移动终端浏览器版本信息
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或uc浏览器
        iPhone: u.indexOf('iPhone') > -1, //是否为iPhone或者QQHD浏览器
        iPad: u.indexOf('iPad') > -1, //是否iPad
        webApp: u.indexOf('Safari') == -1, //是否web应该程序，没有头部与底部
        iosv: u.substr(u.indexOf('iPhone OS') + 9, 3),
        weixin: u2.match(/MicroMessenger/i) == "micromessenger",
        ali: u.indexOf('AliApp') > -1,
    };
}
