$(document).ready(function() {
	var getParam = function(name) {
	    var url = window.preview_url;
	    var reg = new RegExp('(\\?|&)' + name + '=([^&?]*)', 'i');
	    var arr = url.match(reg);
	    if (arr) return arr[2];
	}
	var crid = window.crid || '';
	var preview_url = window.preview_url || ''
	var Mugeda, scene, mugeda;
	var pageLen = 0;
	var currentPage = 0;
	var startFrame = 0;
    var source = window.source;;
    var preview_title = window.title;;

    var $qrcode = $('#qrcode');
	var $title = $('#title');

	window['_CUSTOM_TAG'] = 'Mucard_public';
	var url = '';

	if(preview_url != '' || crid != ''){

		if (preview_url != '') {
			url = decodeURIComponent(preview_url);
		} else if(crid != '') {
			url = "//mucard.mugeda.com/weixin/card/index.html?crid="+crid;
		}

		if(source == 'cases') {
		  $('.share').hide();
		}
        document.title = html_title
		$('#iframe_content').attr({"src": url});
		generatePreviewQrcode($qrcode, url, 120, 120);
    	$title.html(decodeURIComponent(preview_title));

		$('.up').click(function(event) {

			Mugeda = $('#iframe_content')[0].contentWindow.window.Mugeda;
			if(!Mugeda){
				return
			}
			mugeda = Mugeda.getMugedaObject();
			scene = mugeda.scene;
			if(scene.pages){
				pageLen = scene.pages.length;

				if(currentPage < pageLen){
					currentPage = currentPage + 1;
					if(mugeda.scene.pages[currentPage]){
						startFrame = mugeda.scene.pages[currentPage].startFrame;
						scene.gotoAndPlay(startFrame);
					}
				}
			}
			
		});
		$('.down').click(function(event) {

			Mugeda = $('#iframe_content')[0].contentWindow.window.Mugeda;
			if(!Mugeda){
				return
			}
			mugeda = Mugeda.getMugedaObject();
			scene = mugeda.scene;
			if(scene.pages){
				pageLen = scene.pages.length;

				if(currentPage > 0){
					currentPage = currentPage - 1;
					if(currentPage == pageLen -1){
						currentPage = currentPage -1;
					}
					if(mugeda.scene.pages[currentPage]){
						startFrame = mugeda.scene.pages[currentPage].startFrame;
						scene.gotoAndPlay(startFrame);
					}
				}
			}

		});
	}

    $('.all-tag').mouseenter(function () {
        var $bar = $(this);
        $bar.find('.tag-box').css('top','35px');
    }).mouseleave(function () {
        var $bar = $(this);
        $bar.find('.tag-box').css('top','-10000px');
    })

	$container = $('.main');
	$oheight = $(window).height() - 80;
	if(760 < $oheight){
		$container.css({'height': $oheight});
	}

	$(window).resize(function() {
		$height = $(window).height() - 80;
		if(760 < $height ){
			$container.css({
				'height': $height
			})
		}
	});

    // 使用模版
    var templCopyer = new templateCopy({
        url: location.protocol + '//' +  location.hostname + '/api_creative_copy.php',
        dialog_ele: '#dialog_cases',
        dialog_btn_text: '确定',
        dialog_lbtn_text: '去看看',
        dialog_rbtn_text: '重新选',
        dialog_text: '您选择的《template_title》已经复制到您的模板列表中，您可以直接使用了',
        dialog_text_err: '《template_title》已经在您的模板列表中了！',
        dialog_redirect_url: '/templist.php',
        dialog_rbtn_url: '/template.php',
        dialog_width: 500
    });
    $('.case_edit').on('click', function(e){
        e.preventDefault();
        var $this = $(this);
        $this.prev('.count').trigger('click');
        var title = $('#case_title').val();
        var thumbnail_url = $('#thumbnail_url').val();
        templCopyer.convertToTemplate(crid, title, thumbnail_url);
    });

    // 企业会员免费使用
    $('#checkout_user_type').on('click', function(e){
        $.ajax({
            url: '/json.php',
            type: 'get',
            dataType: 'json',
            data: {
                action: 'getInfo'
            },
        })
            .done(function(res) {
                if (res.status == 0 && res.user_type == 2 &&  res.ontrial == 1) {
                    $('#dialog_pricing_tips').dialog({
                        resizable: false,
                        draggable: false,
                        width: 600,
                        // height: 290,
                        modal: true,
                        title: '',
                        buttons: {
                            "确定": function() {
                                $(this).dialog('close');
                                location.href = "/pricing.php";
                            },
                            "取消": function() {
                                $(this).dialog('close');
                            }
                        }
                    }).show();
                } else {
                    location.href = "/pricing.php";
                }
            });
    });

    function get_designer_creatives (urid, callback) {

        if(!urid){
            $('#creativeBox').html('<p style="text-align: center"><img src="/images/cases/zanwushuju.png" height="129px" style="margin-top: -30px;"></p>' +
                '<p style="text-align: center;color: #C5C9D1;font-size: 16px;margin-top: -37px;">暂无数据...</p>');
            return;
        }

        if(transverse == 1 || preview_type == "template"){
            var perpage = 3;
        }else{
            var perpage = 6;
        }
        $.ajax({
            url: '/api_designer_creatives.php',
            type: 'get',
            dataType: 'json',
            data: {
                action: 'zuopin_liebiao',
                urid: urid,
                perpage: perpage,
                t:(new Date() *1)
            },
        })
            .done(function(res) {

                if(res && res.status == 0){
                    if(callback){
                        callback(res)
                    }
                }else{
                    $('#error_dialog').dialog({
                        'resizable': false,
                        'width': 200,
                        'height': 200,
                        'modal': true,
                        'buttons': [{
                            'text': '确定',
                            'class': 'dialog_button',
                            'click': function() {
                                $(this).dialog('close');
                            }
                        }]
                    }).text('获取设计师作品出错，请稍后重试或联系我们');
                }
            })
            .fail(function() {
                console.log("error");
                $('#error_dialog').dialog({
                    'resizable': false,
                    'width': 200,
                    'height': 200,
                    'modal': true,
                    'buttons': [{
                        'text': '确定',
                        'class': 'dialog_button',
                        'click': function() {
                            $(this).dialog('close');
                        }
                    }]
                }).text('没有得到设计师作品，请稍后重试或联系我们');
            })
            .always(function() {
                console.log("complete");
            });

    }

    var renderCreativesList = function(data){
        if(!data) return;
        var $creative = $('#creative');
        if((data && data.list.length > 0 && preview_type == "case") || (data && data.shows.length >0 && preview_type == "template")){

            $.each(data.list, function(index, el) {
                el.updated_at = el.updated_at.match(/\d{4}-\d{2}-\d{2}/g);

                //过滤全部模板标签
                try {
                    el.tags = el.tags.replace(',全部模板,','signsign');
                    el.tags = el.tags.replace('signsign','');
                    el.tags = el.tags.replace(',全部模板','');
                    el.tags = el.tags.replace('全部模板,','');
                    // el.preview_url = encodeURIComponent(el.preview_url);
                } catch (e) {
                    console.log(e.name + ": " + e.message);
                }

            });

            $('.loading').hide();
            if(preview_type == "case"){
                $('#creativeBox').html($creative.tmpl({creative: data.list}));
            }else{
                $('#creativeBox').html($creative.tmpl({creative: data.shows}));
            }
        }else{
            $('#creativeBox').html('<p style="text-align: center"><img src="/images/cases/zanwushuju.png" height="129px" style="margin-top: -30px;"></p>' +
                '<p style="text-align: center;color: #C5C9D1;font-size: 16px;margin-top: -37px;">暂无数据...</p>');
        }


    }
    // getLikeData();
    function getLikeData() {
        if(preview_type == "case"){
            var API = '/api_case_list.php';
            var pd = {
                searchKeyword: '',
                senceFilter: {'value':senceTag, 'toggle': false},
                featureFilter: {'value':businessTag, 'toggle': false},
                businessFilter: {'value':featureTag, 'toggle': false},
                orderBy: {by:'date', sort: 'desc'},
                page: 1,
                perpage: 12,
                similar:1
            };
            var requestData = {
                url: API,
                method: 'POST',
                data: pd
            };
        } else {
            var API = '/api_show.php';
            var pd = {
                action:'show_sell',job:template_job ,cate:senceTag ,func:businessTag,style:featureTag,perpage:12,similar:1
            };
            var requestData = {
                url: API,
                method: 'GET',
                data: pd
            };
        }

        var requestPromise = $.ajax(requestData);
        requestPromise.done(function(res){

            if(res.status === 0) {
                renderLikeList(res);
            } else {
                alert(res.error);
            }
        });
        requestPromise.fail(function(){alert('请求接口失败');});
    }

    function renderLikeList(data) {
        var $cases = $('#cases');
        if(data && data.shows && data.shows.length > 0) {
            //处理date和preview_url
            $('#Likebox').html($cases.tmpl({shows: data.shows}));
        } else {
            $('#Likebox').html('<p class="case_loading">'+ kPageMessages.nodata +'</p>');
        }
    }

    $(".create-btn").click(function () {
    	if(is_login == 1){
    		window.open("/workbench_new.php");
		}else{
    		var url = '/case_preview/' + param_id +'.html';
    		 url = "/index.php?target=login&redirect_url=" + url + "#login_box";
    		window.open(url);
		}
    });


    // get_designer_creatives(designer_urid,renderCreativesList);
    // if(preview_type == "template") {
    //     getRelation();
    // }
    function getRelation(){
        if(preview_type == "template"){
            var API = '/api_show.php';
            var pd = {
                action:'show_cate',title:template_job
            };
            var requestData = {
                url: API,
                method: 'GET',
                data: pd
            };
        }
        var requestPromise = $.ajax(requestData);
        requestPromise.done(function(res){
            if(res.status === 0) {
                renderRelationList(res);
            } else {
                alert(res.error);
            }
        });
    }
    function renderRelationList(data){
        var $relation = $('#relation');
        if(data && data.result && data.result.length > 0) {
            //处理date和preview_url
            $('#relation-box').html($relation.tmpl({result: data.result}));
        } else {
            $('#relation-box').html('<p class="case_loading">'+ kPageMessages.nodata +'</p>');
        }
    }
    $("#show-guide").popover({ trigger: "manual" , html: true, animation:false})
        .on("mouseenter", function () {
            var _this = this;   // 这里的this触发的dom,需要存起来 否则在下面 .popover的逻辑中this会变为弹出的dom
            $(this).popover("show");
            $(".popover").on("mouseleave", function () {
                $(_this).popover('hide');
            });
        }).on("mouseleave", function () {
        var _this = this;
        setTimeout(function () {
            if (!$(".popover:hover").length) {
                $(_this).popover("hide");
            }
        }, 300);
    });
});
